doctype html
html
	head
		meta( charset='UTF-8')
		meta( name='viewport', content='maximum-scale=1,width=device-width,initial-scale=1,user-scalable=0')
		title Barnes Collection Scripts Dashboard
		link(href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css", rel="stylesheet")
		link( href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.13/css/dataTables.bootstrap.css", rel="stylesheet")
		script(src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js")
		script(src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js")
		script(src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js")
	body
		h1 Dashboard
		section
			div.panel.panel-default
				div.panel-heading
					h2.panel-title TMS to CSV Exporter
				div.panel-body
					p
						span Script last ran: 
						span#lastRan= moment(info.startTime).toString()
					p
						span Script last completed: 
						span#lastCompleted= moment(info.completeTime).toString()
					p
						span Script running: 
						span#active= info.active
					p
						span Progress: 
						span#progress= `${info.progress.processed} of ${info.progress.total} objects processed`
					p
						span Listening for updates on port: 
						span#port= info.updatePort
					button#run Run Script
					button#cancel Cancel Script
		section
			div.panel.panel-default
				div.panel-heading
					h2.panel-title Exported CSV files
				div.panel-body
					table#csvFiles.table.table-striped.table-condensed.dataTable
						thead
							tr
								th name
								th time ran
								th status
								th view online
								th download
								th view warnings online
								th download warnings
								th sync
						tbody
						each file in list.files
							tr
								td= file.name
								td= file.createdAt
								td= file.status
								td
									a(href= "/" + file.name + "/objects") View Online
								td
									a(href="/output/" + file.name + "/objects.csv") Download
								td
									a(href= "/" + file.name + "/warnings") View Warnings Online
								td
									a(href="/output/" + file.name + "/warnings.csv") Download Warnings
								td
									- var completed = (file.status === "COMPLETED")
									if completed
										- var synced = (file.name === desc.lastImportedCSV)
										if (synced)
											strong= "Synced"
		section
			div.panel.panel-default
				div.panel-heading
					h2.panel-title Elasticsearch
				div.panel-body
					div.row
						div.col-lg-6
							text#es_status= `ES synchronized with ${desc.lastImportedCSV}`
					div.row
						div.col-lg-6
							div.input-group
								input#query.form-control(type="text" name="es_query" placeholder="Search for...")
								span.input-group-btn
									button#query_button.btn.btn-default(type="button") Search
						div.col-lg-6
							a(href="/app/kibana") View on Kibana
					div.row
						div.col-lg-12
							text#search_results
	script.
		$(function() {
			var socket;

			function connectUpdateSocket(port) {
				$("#port").text(port);
				socket = io(window.location.protocol + "//" + window.location.hostname + ":" + port + window.location.pathname);
				socket.on('active', function(data){
					$("#active").text(data);
				});
				socket.on('progress', function(data){
					$("#progress").text(`${data.processed} of ${data.total} objects processed`);
				});
			}

			function doSearchQuery() {
				var query = $("#query")[0].value;
				var port = 9200;
				console.log("Searching for: " + query);
				$.get(window.location.protocol + "//" + window.location.hostname + ":" + port + "/_search?pretty&q=" + query, updateSearchResults);
			}

			function updateSearchResults(data) {
				$("#search_results").text(JSON.stringify(data));
			}

			connectUpdateSocket(parseInt($('#port').text()));

			$("#run").click(function() {
				$.get('api/tmstocsv/run', function(response) {
					$("#test").text(response.time);
				});
			});

			$("#cancel").click(function() {
				$.get('api/tmstocsv/cancel');
			});

			$("#query_button").click(doSearchQuery);

			$("#query").keypress(function(e, a) {
				if (e.which == 13) {
					doSearchQuery();
					return false;    //<---- Add this line
				}
			});
		});