<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>util/csvUtil.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ArtObject.html">ArtObject</a><ul class='methods'><li data-type='method'><a href="ArtObject.html#descriptionWithFields">descriptionWithFields</a></li></ul></li><li><a href="CSVPluginAPI.html">CSVPluginAPI</a><ul class='methods'><li data-type='method'><a href="CSVPluginAPI.html#list">list</a></li></ul></li><li><a href="CSVWriter.html">CSVWriter</a><ul class='methods'><li data-type='method'><a href="CSVWriter.html#end">end</a></li><li data-type='method'><a href="CSVWriter.html#write">write</a></li></ul></li><li><a href="ESCollection.html">ESCollection</a><ul class='methods'><li data-type='method'><a href="ESCollection.html#_analyzedData">_analyzedData</a></li><li data-type='method'><a href="ESCollection.html#_deleteCollectionIndex">_deleteCollectionIndex</a></li><li data-type='method'><a href="ESCollection.html#_isIndexReadyForSync">_isIndexReadyForSync</a></li><li data-type='method'><a href="ESCollection.html#clearCollectionObjects">clearCollectionObjects</a></li><li data-type='method'><a href="ESCollection.html#description">description</a></li><li data-type='method'><a href="ESCollection.html#initialize">initialize</a></li><li data-type='method'><a href="ESCollection.html#syncESToCSV">syncESToCSV</a></li></ul></li><li><a href="ESCollection.ESCollectionException.html">ESCollectionException</a></li><li><a href="ESPluginAPI.html">ESPluginAPI</a><ul class='methods'><li data-type='method'><a href="ESPluginAPI.html#desc">desc</a></li><li data-type='method'><a href="ESPluginAPI.html#sync">sync</a></li></ul></li><li><a href="ExportConfig.html">ExportConfig</a><ul class='methods'><li data-type='method'><a href="ExportConfig.html#fieldHasAlias">fieldHasAlias</a></li><li data-type='method'><a href="ExportConfig.html#fieldIsEnumerated">fieldIsEnumerated</a></li><li data-type='method'><a href="ExportConfig.html#fieldIsMask">fieldIsMask</a></li><li data-type='method'><a href="ExportConfig.html#fieldIsRequired">fieldIsRequired</a></li><li data-type='method'><a href="ExportConfig.html#fieldMaskSelector">fieldMaskSelector</a></li></ul></li><li><a href="ExportMetadata.html">ExportMetadata</a><ul class='methods'><li data-type='method'><a href="ExportMetadata.html#description">description</a></li></ul></li><li><a href="ImagesPluginAPI.html">ImagesPluginAPI</a><ul class='methods'><li data-type='method'><a href="ImagesPluginAPI.html#info">info</a></li><li data-type='method'><a href="ImagesPluginAPI.html#tile">tile</a></li></ul></li><li><a href="ImageUploader.html">ImageUploader</a><ul class='methods'><li data-type='method'><a href="ImageUploader.html#process">process</a></li></ul></li><li><a href="module-util_senecaPluginAPI-SenecaPluginAPI.html">SenecaPluginAPI</a></li><li><a href="TMSExporter.html">TMSExporter</a><ul class='methods'><li data-type='method'><a href="TMSExporter.html#cancelExport">cancelExport</a></li><li data-type='method'><a href="TMSExporter.html#exportCSV">exportCSV</a></li></ul></li><li><a href="TMSFileReader.html">TMSFileReader</a><ul class='methods'><li data-type='method'><a href="TMSFileReader.html#hasNext">hasNext</a></li><li data-type='method'><a href="TMSFileReader.html#next">next</a></li></ul></li><li><a href="TMSURLReader.html">TMSURLReader</a><ul class='methods'><li data-type='method'><a href="TMSURLReader.html#getObjectCount">getObjectCount</a></li><li data-type='method'><a href="TMSURLReader.html#hasNext">hasNext</a></li><li data-type='method'><a href="TMSURLReader.html#next">next</a></li></ul></li><li><a href="WarningReporter.html">WarningReporter</a><ul class='methods'><li data-type='method'><a href="WarningReporter.html#appendFieldsForObject">appendFieldsForObject</a></li><li data-type='method'><a href="WarningReporter.html#end">end</a></li></ul></li><li><a href="WebsocketUpdater.html">WebsocketUpdater</a></li></ul><h3>Modules</h3><ul><li><a href="module-util_csvUtil.html">util/csvUtil</a><ul class='methods'><li data-type='method'><a href="module-util_csvUtil.html#.csvCompleted">csvCompleted</a></li><li data-type='method'><a href="module-util_csvUtil.html#.csvForEach">csvForEach</a></li><li data-type='method'><a href="module-util_csvUtil.html#.diffCSV">diffCSV</a></li><li data-type='method'><a href="module-util_csvUtil.html#.doCSVKeysMatch">doCSVKeysMatch</a></li><li data-type='method'><a href="module-util_csvUtil.html#.getLastCompletedCSV">getLastCompletedCSV</a></li></ul></li><li><a href="module-util_senecaPluginAPI.html">util/senecaPluginAPI</a><ul class='methods'><li data-type='method'><a href="module-util_senecaPluginAPI.html#.makeAPI">makeAPI</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="UpdateEmitter.html#event:completed">completed</a></li><li><a href="UpdateEmitter.html#event:progress">progress</a></li><li><a href="UpdateEmitter.html#event:started">started</a></li><li><a href="WebsocketUpdater.html#event:status">status</a></li></ul><h3>Interfaces</h3><ul><li><a href="TMSReader.html">TMSReader</a><ul class='methods'><li data-type='method'><a href="TMSReader.html#hasNext">hasNext</a></li><li data-type='method'><a href="TMSReader.html#next">next</a></li></ul></li><li><a href="UpdateEmitter.html">UpdateEmitter</a><ul class='methods'><li data-type='method'><a href="UpdateEmitter.html#completed">completed</a></li><li data-type='method'><a href="UpdateEmitter.html#progress">progress</a></li><li data-type='method'><a href="UpdateEmitter.html#started">started</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">util/csvUtil.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Utitly functions for working with CSV files
 * @module
 */

const fs = require('fs');
const _ = require('lodash');
const path = require('path');
const tmp = require('tmp');
const shell = require('shelljs');
const csv = require('fast-csv');
const pypath = require('config').Python.path;

const output = shell.exec('which bash');
const bashPath = output.stdout.trim();

function logShellOutput(logger, op) {
	if (op.code === 0) {
		logger.info(op.stdout);
	} else {
		logger.error(op.sterr);
	}
}

/**
 * Read just the first line of a file (up to the first newline character)
 * @private
 * @param {string} path - File path
 * @return {Promise} Resolves to the first line of the file
 */
const _readFirstLine = function (filePath) {
	return new Promise((resolve, reject) => {
		const rs = fs.createReadStream(filePath, { encoding: 'utf8' });
		let acc = '';
		let pos = 0;
		let index;
		rs
			.on('data', (chunk) => {
				index = chunk.indexOf('\n');
				acc += chunk;
				if (index !== -1) {
					rs.close();
				} else {
					pos += chunk.length;
				}
			})
			.on('close', () => {
				resolve(acc.slice(0, pos + index));
			})
			.on('error', (err) => {
				reject(err);
			});
	});
};

/**
 * Calls a callback function for each row of a CSV on the given CSV path.
 * First row of the CSV must be headers. Callback function has one argument,
 * an object whose keys are the header columns.
 * @param {string} csvPath - Path to the csv file
 * @param {function} cb - Function to call on each row
 */
module.exports.csvForEach = function (csvPath, cb, completedCb) {
	const stream = fs.createReadStream(csvPath);
	csv.fromStream(stream, { headers: true })
		.on('data', cb)
		.on('end', completedCb);
};

/**
 * Whether or not the csv export contained in the given directory ran to completion or not
 * @param {string} csvDirPath - Path to the folder containing the files exported by the
 *  CSV export script
 * @return {bool} True if the CSV export script ran to completion, false otherwise
 */
module.exports.csvCompleted = function (csvDirPath) {
	const metapath = path.join(csvDirPath, 'meta.json');
	try {
		const status = JSON.parse(fs.readFileSync(metapath, 'utf8')).status;
		return status.toLowerCase() === 'completed';
	} catch (e) {
		return false;
	}
};

/**
 * Whether or not the header keys for two CSV files are the same or different
 * (the headers need not be in the same order to be the same)
 * @param {string} csvFilePathA - Path to the first objects.csv file
 * @param {string} csvFilePathB - Path to the second objects.csv file
 * @return {Promise} Resolves to true if the headers match, false otherwires
 */
module.exports.doCSVKeysMatch = function (csvFilePathA, csvFilePathB, delim = ',') {
	const proms = [];
	proms.push(_readFirstLine(csvFilePathA));
	proms.push(_readFirstLine(csvFilePathB));
	const all = Promise.all(proms);
	return all.then((res) => {
		const keysA = res[0].split(delim);
		const keysB = res[1].split(delim);
		return _.difference(keysA, keysB).length === 0 &amp;&amp; _.difference(keysB, keysA).length === 0;
	}, (err) => {
		throw err;
	});
};

/**
 * Name of the most recent CSV directory, given the directory containing CSV directories
 * @param {string} csvRootDir - Path to the directory containing csv_* directories,
 *  as output by the CSV export script
 * @return {string} Name of the most recent CSV directory
 */
module.exports.getLastCompletedCSV = function (csvRootDir) {
	let dirs = fs.readdirSync(csvRootDir);
	dirs = _.filter(dirs, d => d.startsWith('csv_')).sort();
	dirs = _.filter(dirs, d => module.exports.csvCompleted(path.join(csvRootDir, d)));
	if (dirs.length > 0) return dirs.pop();
	return null;
};

/**
 * Diffs two csvs and returns a JSON object of all fields changed, added, or removed
 * using the python library csvdiff.
 * @param {string} oldCSVPath - Path to the old CSV file
 * @param {string} newCSVPath - Path to the new CSV file
 * @param {logger} logger - instance of winston logger, specific to the microservice
 * @return {object} the diff in JSON form
 */
module.exports.diffCSV = function (oldCSVPath, newCSVPath, logger) {
	const pyDiff = path.resolve(__dirname, '../python_scripts/py_csv_diff.py');
	const resolvedOldPath = path.relative('.', oldCSVPath);
	const resolvedNewPath = path.relative('.', newCSVPath);
	const tmpDir = tmp.dirSync();
	const outputJsonFile = path.join(tmpDir.name, 'diff.json');
	logger.info(`Running CSV diff python script on ${oldCSVPath} ${newCSVPath}`);
	logShellOutput(logger, shell.exec(`source ${pypath}/activate tmsdiff`, { shell: bashPath }));
	logShellOutput(logger, shell.exec(`python ${pyDiff} ${resolvedOldPath} ${resolvedNewPath} ${outputJsonFile}`, { shell: bashPath }));
	logShellOutput(logger, shell.exec(`source ${pypath}/deactivate`, { shell: bashPath }));
	return JSON.parse(fs.readFileSync(outputJsonFile));
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Tue May 02 2017 15:37:24 GMT-0400 (EDT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
